<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Game To√°n 8 ‚Äì Thi & BXH</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0f1a;color:#e7f5ff;margin:0;padding:20px}
  .wrap{max-width:980px;margin:0 auto}
  .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px 24px;box-shadow:0 10px 40px rgba(0,0,0,.3);margin-bottom:16px}
  h1{margin:6px 0 12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  label{display:block;margin:8px 0 4px;font-weight:600}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#fff;outline:none;font-size:16px}
  input:focus,select:focus{border-color:#54e1ff;box-shadow:0 0 0 2px rgba(84,225,255,.15)}
  button{background:linear-gradient(90deg,#00c2ff,#ff7a18);color:#0b0f1a;font-weight:800;border:none;cursor:pointer}
  button:hover{filter:brightness(1.08)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .hidden{display:none}
  .qcard{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:12px;margin:10px 0}
  .opt{display:block;background:rgba(255,255,255,.06);padding:6px 8px;border-radius:8px;margin:6px 0;cursor:pointer}
  .topbar{display:flex;align-items:center;justify-content:space-between}
  table{width:100%;border-collapse:collapse;margin-top:10px;color:#fff}
  th,td{border:1px solid rgba(255,255,255,.15);padding:8px;text-align:center}
  th{background:#0ea5e9}
  tbody tr:nth-child(1){background:gold;color:#111;font-weight:800}
  tbody tr:nth-child(2){background:silver;color:#111;font-weight:800}
  tbody tr:nth-child(3){background:#cd7f32;color:#111;font-weight:800}
  .note{opacity:.85}
</style>
</head>
<body>
<div class="wrap">

  <!-- ƒêƒÉng nh·∫≠p / th√¥ng tin -->
  <div class="card" id="loginCard">
    <h1>üéÆ Game To√°n 8 ‚Äì Thi & L√™n Rank</h1>
    <p class="note">Nh·∫≠p th√¥ng tin ƒë·ªÉ b·∫Øt ƒë·∫ßu thi. ƒêi·ªÉm s·∫Ω t√≠nh t·ª± ƒë·ªông ‚Äì kh√¥ng c·∫ßn ‚Äúnh·∫≠p ƒëi·ªÉm‚Äù th·ªß c√¥ng.</p>
    <div class="grid">
      <div>
        <label>H·ªç v√† t√™n</label>
        <input id="name" placeholder="VD: Nguy·ªÖn VƒÉn A" required>
        <label>L·ªõp</label>
        <select id="class" required>
          <option value="" disabled selected>L·ªöP</option>
          <option>8A1</option><option>8A2</option><option>8A3</option><option>8A4</option>
          <option>8A5</option><option>8A6</option><option>8A7</option>
        </select>
        <label>Nickname (hi·ªÉn th·ªã BXH)</label>
        <input id="nickname" placeholder="VD: MathKing" required>
      </div>
      <div>
        <label>Th·ªùi l∆∞·ª£ng b√†i thi</label>
        <input id="durationLimit" type="number" value="10" min="3" max="30">
        <p class="note">M·∫∑c ƒë·ªãnh 10 ph√∫t / 10 c√¢u. C√≥ th·ªÉ ƒë·ªïi 3‚Äì30 ph√∫t.</p>
      </div>
    </div>
    <div class="row">
      <button id="startBtn">üö© B·∫ÆT ƒê·∫¶U THI</button>
      <button id="seeRankBtn">üìä Xem BXH</button>
    </div>
  </div>

  <!-- Khu thi -->
  <div class="card hidden" id="examCard">
    <div class="topbar">
      <h2>üö© ƒêang thi: 10 c√¢u</h2>
      <div id="timer">‚è≥ 10:00</div>
    </div>
    <div id="quizBox"></div>
    <div class="row">
      <button id="submitBtn">N·ªôp b√†i</button>
      <button id="cancelBtn" type="button">Hu·ª∑ & V·ªÅ trang ƒë·∫ßu</button>
    </div>
  </div>

  <!-- B·∫£ng x·∫øp h·∫°ng -->
  <div class="card" id="rankCard">
    <div class="topbar">
      <h2>üèÜ B·∫£ng X·∫øp H·∫°ng Top 10</h2>
      <button id="refreshRankBtn">L√†m m·ªõi</button>
    </div>
    <table>
      <thead><tr><th>H·∫°ng</th><th>Nickname</th><th>L·ªõp</th><th>ƒêi·ªÉm</th><th>Th·ªùi gian</th></tr></thead>
      <tbody id="rankBody"><tr><td colspan="5">Ch∆∞a t·∫£i‚Ä¶</td></tr></tbody>
    </table>
  </div>

</div>

<script>
// üëâ THAY API_URL n·∫øu b·∫°n v·ª´a redeploy Apps Script ra URL m·ªõi
const API_URL = "https://script.google.com/macros/s/AKfycbwyht9uRhyek_sQ0g-fNxr82TCY-AEEyFvgJkMwjmabSUGC3UW4I2X0KpuhlLF6NMJa/exec";

// ====== C√¢u h·ªèi m·∫´u (10 c√¢u) ‚Äì C√≥ th·ªÉ thay b·∫±ng b·ªô c√¢u h·ªèi ri√™ng ======
const QUESTION_BANK = [
  {q:"Gi√° tr·ªã 2^3 =", a:["6","8","9","12"], r:1},
  {q:"ƒê∆°n th·ª©c l√†:", a:["Bi·ªÉu th·ª©c kh√¥ng c√≥ bi·∫øn","T·ªïng nhi·ªÅu h·∫°ng t·ª≠","T√≠ch gi·ªØa s·ªë v√† bi·∫øn l≈©y th·ª´a nguy√™n kh√¥ng √¢m","Th∆∞∆°ng hai ƒëa th·ª©c"], r:2},
  {q:"B·∫≠c c·ªßa ƒë∆°n th·ª©c 5x^2y l√†:", a:["2","3","1","5"], r:1},
  {q:"(x)(x^2) =", a:["x^2","x^3","x^4","2x^2"], r:1},
  {q:"(a+b)^2 =", a:["a^2+b^2","a^2+2ab+b^2","2a^2+b^2","a^2-2ab+b^2"], r:1},
  {q:"ƒêa th·ª©c l√† t·ªïng c·ªßa:", a:["C√°c ƒë∆°n th·ª©c","C√°c s·ªë nguy√™n","C√°c ph√¢n s·ªë","C√°c ph∆∞∆°ng tr√¨nh"], r:0},
  {q:"H·ªá s·ªë c·ªßa -7x trong -7x+3:", a:["-7","7","-3","3"], r:0},
  {q:"(x+y)+(x-y) =", a:["2x","2y","x","0"], r:0},
  {q:"N·∫øu 3a=12 th√¨ a =", a:["2","3","4","6"], r:2},
  {q:"Gi√° tr·ªã x trong 2x+4=10:", a:["2","3","4","5"], r:1}
];

// ====== Tr·∫°ng th√°i & ti·ªán √≠ch ======
let picked = [];      // 10 c√¢u ƒë√£ ch·ªçn
let answers = {};     // ƒë√°p √°n HS tick
let timeLeft = 0;     // gi√¢y
let timerId = null;

const $ = (id)=>document.getElementById(id);

function mmss(s){
  const m = Math.floor(s/60), sec = s%60;
  return `${m}:${String(sec).padStart(2,'0')}`;
}
function shuffle(arr){return arr.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]);}

// ====== API ======
async function sendResult(payload){
  try{
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    return j && j.result === "success";
  }catch(e){ console.error(e); return false; }
}

async function getRanking(){
  try{
    const res = await fetch(API_URL + "?action=getRanking");
    return await res.json();
  }catch(e){ console.error(e); return []; }
}

function renderRank(list){
  const tb = $("rankBody");
  tb.innerHTML = "";
  if(!list.length){ tb.innerHTML = `<tr><td colspan="5">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>`; return; }
  list.forEach((r,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${r.nickname||""}</td><td>${r.class||""}</td><td>${r.score||0}</td><td>${r.duration||""}</td>`;
    tb.appendChild(tr);
  });
}

// ====== Lu·ªìng thi ======
$("startBtn").onclick = ()=>{
  const name = $("name").value.trim();
  const cls = $("class").value.trim();
  const nick = $("nickname").value.trim();
  const limitMin = Math.max(3, Math.min(30, parseInt($("durationLimit").value||10)));

  if(!name || !cls || !nick){ alert("Vui l√≤ng nh·∫≠p ƒë·ªß H·ªç t√™n, L·ªõp, Nickname."); return; }

  // L∆∞u t·∫°m tr√™n m√°y ƒë·ªÉ n·ªôp b√†i
  localStorage.setItem("name", name);
  localStorage.setItem("class", cls);
  localStorage.setItem("nickname", nick);

  // ch·ªçn 10 c√¢u, render
  picked = shuffle(QUESTION_BANK).slice(0,10);
  answers = {};
  const box = $("quizBox");
  box.innerHTML = "";
  picked.forEach((q,idx)=>{
    const div = document.createElement("div");
    div.className = "qcard";
    div.innerHTML = `<div><b>C√¢u ${idx+1}:</b> ${q.q}</div>
      ${q.a.map((op,i)=>`
        <label class="opt">
          <input type="radio" name="q${idx}" value="${i}"> ${op}
        </label>
      `).join("")}`;
    box.appendChild(div);
  });
  document.querySelectorAll('#quizBox input[type="radio"]').forEach(inp=>{
    inp.addEventListener("change", e=>{
      const idx = Number(e.target.name.replace("q",""));
      answers[idx] = Number(e.target.value);
    });
  });

  // hi·ªÉn th·ªã khu thi
  $("loginCard").classList.add("hidden");
  $("examCard").classList.remove("hidden");

  // timer
  timeLeft = limitMin*60;
  $("timer").textContent = "‚è≥ " + mmss(timeLeft);
  clearInterval(timerId);
  timerId = setInterval(()=>{
    timeLeft--;
    $("timer").textContent = "‚è≥ " + mmss(timeLeft);
    if(timeLeft<=0){ clearInterval(timerId); submitExam(); }
  },1000);
};

$("submitBtn").onclick = submitExam;
$("cancelBtn").onclick = ()=>{
  clearInterval(timerId);
  $("examCard").classList.add("hidden");
  $("loginCard").classList.remove("hidden");
};

async function submitExam(){
  clearInterval(timerId);

  // ch·∫•m ƒëi·ªÉm
  let score = 0;
  picked.forEach((q,i)=>{ if(answers[i]===q.r) score++; });

  const name = localStorage.getItem("name")||"";
  const cls = localStorage.getItem("class")||"";
  const nick = localStorage.getItem("nickname")||"";
  const durationUsed = (parseInt($("durationLimit").value||10)*60 - Math.max(0,timeLeft)); // gi√¢y ƒë√£ d√πng
  const durText = mmss(durationUsed);

  // g·ª≠i l√™n Sheets
  const ok = await sendResult({
    name, class: cls, nickname: nick,
    score, duration: durText
  });

  if(ok){
    alert(`‚úÖ ƒê√£ n·ªôp b√†i: ${score}/10 c√¢u ‚Ä¢ Th·ªùi gian ${durText}`);
    $("examCard").classList.add("hidden");
    $("loginCard").classList.remove("hidden");
    loadRank();
  }else{
    alert("‚ùå Kh√¥ng g·ª≠i ƒë∆∞·ª£c ƒëi·ªÉm. Ki·ªÉm tra l·∫°i API_URL ho·∫∑c redeploy Web app (Anyone).");
  }
}

// ====== BXH ======
async function loadRank(){
  const data = await getRanking();
  renderRank(data);
}
$("refreshRankBtn").onclick = loadRank;
$("seeRankBtn").onclick = loadRank;

// T·∫£i BXH khi m·ªü trang
loadRank();
</script>
</body>
</html>
